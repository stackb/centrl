syntax = "proto3";

package build.stack.bazel.symbol.v1;

option go_package = "github.com/bazel-contrib/bcr-frontend/build/stack/bazel/symbol/v1;sympb";

import "build/stack/starlark/v1beta1/starlark.proto";

// Type of Starlark symbol in a .bzl file
enum SymbolType {
    SYMBOL_TYPE_UNKNOWN = 0;
    SYMBOL_TYPE_RULE = 1;
    SYMBOL_TYPE_FUNCTION = 2;
    SYMBOL_TYPE_PROVIDER = 3;
    SYMBOL_TYPE_ASPECT = 4;
    SYMBOL_TYPE_MODULE_EXTENSION = 5;
    SYMBOL_TYPE_REPOSITORY_RULE = 6;
    SYMBOL_TYPE_MACRO = 7;
    SYMBOL_TYPE_RULE_MACRO = 8;
    SYMBOL_TYPE_VALUE = 9;
    SYMBOL_TYPE_LOAD_STMT = 10;
}

// Information about a Starlark symbol exported from a .bzl file
message Symbol {
    // Symbol type (rule, function, provider, etc.)
    SymbolType type = 1;
    // Symbol name
    string name = 2;
    // Brief description extracted from docstring
    string description = 3;
    // Detailed symbol metadata
    oneof info {
        build.stack.starlark.v1beta1.Rule rule = 4;
        build.stack.starlark.v1beta1.Function func = 5;
        build.stack.starlark.v1beta1.Provider provider = 6;
        build.stack.starlark.v1beta1.Aspect aspect = 7;
        build.stack.starlark.v1beta1.ModuleExtension module_extension = 9;
        build.stack.starlark.v1beta1.RepositoryRule repository_rule = 10;
        build.stack.starlark.v1beta1.Macro macro = 11;
        build.stack.starlark.v1beta1.RuleMacro rule_macro = 12;
        build.stack.starlark.v1beta1.Value value = 13;
        build.stack.starlark.v1beta1.LoadStmt load = 14;
    }
}

// Symbols for a single .bzl file
message File {
    // File label (e.g., "//lib/private:copy_file.bzl")
    build.stack.starlark.v1beta1.Label label = 1;
    // Symbols exported by this file
    repeated Symbol symbol = 2;
    // File description from module docstring
    string description = 3;
    // Error message if symbol extraction failed
    string error = 5;
}

// Source of documentation for a module
enum SymbolSource {
    SYMBOL_SOURCE_UNKNOWN = 0;
    PUBLISHED = 1;        // From published docs.json
    BEST_EFFORT = 2;      // Generated from source analysis
}

// Complete documentation for a module version
message ModuleVersionSymbols {
    // Module name
    string module_name = 1;
    // Module version
    string version = 2;
    // Documented .bzl files
    repeated File file = 3;
    // source type
    SymbolSource source = 4;
}

// Registry of all symbols for a module registry
message ModuleRegistrySymbols {
    // Documentation for all module versions
    repeated ModuleVersionSymbols module_version = 1;
}

// Node in the file load dependency graph
message FileLoadTreeNode {
    // File at this node
    File file = 1;
    // Files loaded by this file
    repeated FileLoadTreeNode children = 2;
    // Whether children were pruned to prevent cycles
    bool pruned = 3;
}

// Complete file load dependency graph for a module
message FileLoadTree {
    // Root files (not loaded by other files in the module)
    repeated FileLoadTreeNode roots = 1;
}
