syntax = "proto3";

package build.stack.bazel.registry.v1;

option go_package = "github.com/stackb/centrl/build/stack/bazel/registry/v1;bzpb";

import "build/stack/starlark/v1beta1/starlark.proto";

// Aggregate type about a module registry and all it's modules
message Registry {
    // list of known modules
    repeated Module modules = 1;
    // repository URL of the registry (e.g. 'https://github.com/bazelbuild/bazel-central-registry')
    string repository_url = 2;
    // URL of the registry UI (e.g. 'https://registry.bazel.build')
    string registry_url = 3;
    // branch name of the repository data (e.g. 'main')
    string branch = 4;
    // commit sha1 of the repository data
    string commit_sha = 5;
    // commit message
    string commit_message = 6;
    // timstamp of the commit date
    string commit_date = 7;
}

// Aggregate type about a module and all it's versions
message Module {
    // the module name
    string name = 1;
    // the module metadata
    ModuleMetadata metadata = 2;
    // list of known versions
    repeated ModuleVersion versions = 3;
    // optional (github or potentially gitlab) repo metadata, if applicable.
    RepositoryMetadata repository_metadata = 4;
}

// Metadata about a Maitainer.
message Maintainer {
    // "email": "lperron@google.com",
    string email = 1;
    // "name": "Laurent Perron"
    string name = 2;
    // "github": "UebelAndre",
    string github = 3;
    // "do_not_notify": true,
    bool do_not_notify = 4;
    // "github_user_id": 704767
    int32 github_user_id = 5;
}

// Metadata about a Module.
message ModuleMetadata {
    // "homepage": "https://github.com/mateidavid/zstr",
    string homepage = 1;
    // "maintainers": []
    repeated Maintainer maintainers = 2;
    // "repository": [ "github:mateidavid/zstr" ],
    repeated string repository = 3;
    // "versions": [ "1.0.7" ],
    repeated string versions = 4;
    // "yanked_versions": { "1.5.0": "Regression in prebuilt artifacts leads to missing rules_rust dep" }
    map<string,string> yanked_versions = 5;
    // "deprecated": "use opentracing-cpp instead"
    string deprecated = 6;
}

enum RepositoryType {
    REPOSITORY_TYPE_UNKNOWN = 0;
    GITHUB = 1;
    GITLAB = 2;
}

// Metadata about a source repository.
message RepositoryMetadata {
    RepositoryType type = 1;
    string organization = 2;
    string name = 3;
    string description = 4;
    int32 stargazers = 5;
    map<string,int32> languages = 6;
    string primary_language = 7;
    string canonical_name = 8;
}

message RepositoryMetadataSet {
    repeated RepositoryMetadata repository_metadata = 1;
}

// Metadata about a source repository.
message BazelRepositoryMetadata {
    RepositoryMetadata repository_metadata = 1;
    repeated BazelRelease release = 2;
}

message BazelRelease {
    // bazel version tag name
    string version = 1;
    // source URL of the .tar.gz asset
    string url = 2;
    // commit details fetched from the release
    ModuleCommit commit = 3;
}

message BazelReleaseSet {
    repeated BazelRelease release = 1;
}

message BazelOption {
  string name = 1;
  string type = 2;
  string default = 3;
  repeated string description = 4;
  bool repeatable = 5;
  bool toggle = 6;
  string short = 7;
  repeated string tag = 8;
  // bazel_version represents which bazel version this flag is present in
  repeated string bazel_version = 9;
  // category represents which bazel version this flag is present in
  repeated string category = 10;
}

message BazelHelpCategory {
  string title = 1;
  repeated BazelOption option = 2;
}


message BazelHelpCommand {
    string command = 1;
    repeated BazelHelpCategory category = 2;
    repeated string usage = 3;
}

enum BazelHelpParseMode {
  // Parsing has seen Usage statement but not the first category
  USAGE = 0;
  // Within a categoy
  CATEGORY = 1;
  // Within a Flag
  FLAG = 2;
}


message BazelHelpVersion {
    string version = 1;
    repeated BazelHelpCommand command = 2;
}

message BazelHelpRegistry {
    repeated BazelHelpVersion version = 1;
}

message ResourceStatus {
    // url is the resource locator
    string url = 1;
    // status represents HTTP status message
    int32 code = 2;
    // status represents HTTP status message
    string message = 3; 
}

message ResourceStatusSet {
    repeated ResourceStatus status = 1;
}

// Source represents a source.json file for a module version
message ModuleSource {
    // URL to the source archive
    string url = 1;
    // Integrity hash (e.g., "sha256-...")
    string integrity = 2;
    // Directory prefix to strip from the archive
    string strip_prefix = 3;
    // Number of leading path components to strip from patch files
    int32 patch_strip = 4;
    // Map of patch file names to their integrity hashes
    map<string, string> patches = 5;
    // Map of overlay file names to their integrity hashes
    map<string, string> overlay = 6;
    // Optional docs url that, if present, should contain a stardoc binary proto.
    string docs_url = 7;
    // Optional mirrors urls
    repeated string mirror_urls = 8;
    // optional (e.g. "archive_type": "tar.gz")
    string archive_type = 9;
    // optional (e.g. "type": "git_repository")
    string type = 10;
    string remote = 11;
    string commit = 12;
    // optional stardoc derived data
    DocumentationInfo documentation = 13;
    // the http response for the docs_url
    ResourceStatus docs_url_status = 14;
    // the http response for the source_url
    ResourceStatus url_status = 15;
     // the git commit SHA for the source URL (resolved from tags/releases, only from github for now)
    string commit_sha = 16;
}

// Attestations represents an attestations.json file for a module version
message Attestations {
    // Attestation represents a single attestation entry
    message Attestation {
        // URL to the attestation file
        string url = 1;
        // Integrity hash of the attestation
        string integrity = 2;
    }
    // Media type for the attestations file
    string media_type = 1;
    // Map of file names to their attestations
    map<string, Attestation> attestations = 2;
}

// ModuleVersion represents a Bazel module version and its dependencies
message ModuleVersion {
    // Module name
    string name = 1;
    // Module version
    string version = 2;
    // compat level
    int32 compatibility_level = 3;
    // bazel compatibility
    repeated string bazel_compatibility = 4;
    // optional repo_name
    string repo_name = 5;
    // Module dependencies
    repeated ModuleDependency deps = 6;
    // Source information from source.json
    ModuleSource source = 7;
    // Attestations information from attestations.json
    Attestations attestations = 8;
    // Presubmit configuration from presubmit.yml
    Presubmit presubmit = 9;
    // optional toolchains to be registered
    repeated string toolchains_to_register = 10;
    // Optional overrides, indexed by module name
    repeated ModuleDependencyOverride override = 11; 
    // information about when the MODULE.bazel file for the version was committed.
    ModuleCommit commit = 12;
    // repository metadadata.  This is canonically stored and serialized on the
    // parent Module, but for the sake of the UI, can be attached to the
    // ModuleVersion for easier template rendering.
    RepositoryMetadata repository_metadata = 13;
    // flag that marks if the current version is the latest one
    bool is_latest_version = 14;
}

// ModuleCommit captures metadata about a git commit for the MODULE.bazel file.
message ModuleCommit {
    // the commit sha
    string sha1 = 1;
    // the commit date
    string date = 2;
    // the commit message
    string message = 3;
    // if the pull_request number could be extracted from the commit message
    string pull_request = 4;
}

message ModuleDependencyOverride {
    // The module name this override applies to
    string module_name = 5;
    // the textual representation
    string code = 6;
    oneof override {
        GitOverride git_override = 1;
        ArchiveOverride archive_override = 2;
        SingleVersionOverride single_version_override = 3;
        LocalPathOverride local_path_override = 4;
    }
}

// ModuleDependency represents a module dependency
message ModuleDependency {
    // Module name
    string name = 1;
    // Module version
    string version = 2;
    // optional reponame
    string repo_name = 3;
    // Whether this is a dev dependency
    bool dev = 4;
    // max_compatibility_level
    int32 max_compatibility_level = 5;
    // Optional override for the dependency
    ModuleDependencyOverride override = 6;
    // true of this dependency does not resolve to a version that exists in the
    // same registry (boost.pin_version has these)
    bool unresolved = 7;
}

// GitOverride represents a git_override directive
// Example:
//
// git_override(
//     module_name = "pybind11_abseil",
//     commit = "70f8b693b3b70573ca785ef62d9f48054f45d786",
//     patch_strip = 1,
//     patches = ["//patches:pybind11_abseil.patch"],
//     remote = "https://github.com/pybind/pybind11_abseil.git",
// )
message GitOverride {
    // Git commit hash
    string commit = 1;
    // Number of leading path components to strip from patch files
    int32 patch_strip = 2;
    // List of patch files to apply
    repeated string patches = 3;
    // Git remote URL
    string remote = 4;
    // branch
    string branch = 5;
}

// ArchiveOverride represents an archive_override directive
// Example:
//
// archive_override(
//     module_name = "com_google_protobuf_v25",
//     integrity = "sha256-e+7ZxRHWMs/3wirACU3Xcg5VAVMDnV2n4Fm8zrSIR0o=",
//     patch_strip = 1,
//     patches = [
//         "@com_google_protobuf//:patches/protobuf_v25/0001-Add-MODULE.bazel.patch",
//         "@com_google_protobuf//:patches/protobuf_v25/0002-Examples-MODULE.bazel.patch",
//         "@com_google_protobuf//:patches/protobuf_v25/0003-relative-labels.patch",
//         "@com_google_protobuf//:patches/protobuf_v25/0004-Add-utf8_range-dependency.patch",
//         "@com_google_protobuf//:patches/protobuf_v25/0005-Make-rules_ruby-a-dev-only-dependency.patch",
//         "@com_google_protobuf//:patches/protobuf_v25/0006-Add-repo_name.patch",
//         "@com_google_protobuf//:patches/protobuf_v25/0007-Java-bazel8.patch",
//     ],
//     strip_prefix = "protobuf-25.0",
//     urls = ["https://github.com/protocolbuffers/protobuf/releases/download/v25.0/protobuf-25.0.tar.gz"],
// )
message ArchiveOverride {
    // Integrity hash (e.g., "sha256-...")
    string integrity = 1;
    // Number of leading path components to strip from patch files
    int32 patch_strip = 2;
    // List of patch files to apply
    repeated string patches = 3;
    // Directory prefix to strip from the archive
    string strip_prefix = 4;
    // URLs to the archive
    repeated string urls = 5;
}

// SingleVersionOverride represents a single_version_override directive
// Example:
//
// single_version_override(
//     module_name = "rules_ruby",
//     patch_strip = 1,
//     patches = [
//         "@com_google_protobuf//:Disable_bundle_install.patch",
//         "@com_google_protobuf//:Neverlink_jruby_jars.patch",
//     ],
//     version = "0.17.3",
// )
message SingleVersionOverride {
    // Number of leading path components to strip from patch files
    int32 patch_strip = 1;
    // List of patch files to apply
    repeated string patches = 2;
    // Version to use
    string version = 3;
}

// LocalPathOverride represents a local_path_override directive
// Example:
//
// local_path_override(
//     module_name = "bazel_worker_api",
//     path = "../proto",
//
message LocalPathOverride {
    // Local filesystem path to the module
    string path = 1;
}

// Presubmit represents a presubmit.yml file for CI testing
message Presubmit {
    // Optional bcr_test_module configuration
    message BcrTestModule {
        // Module path
        string module_path = 1;
        // Matrix configuration
        PresubmitMatrix matrix = 2;
        // Tasks to run
        map<string, PresubmitTask> tasks = 3;
    }

    // Matrix configuration for platforms and bazel versions
    message PresubmitMatrix {
        // List of platforms (e.g., "ubuntu2004", "macos", "windows")
        repeated string platform = 1;
        // List of bazel versions (e.g., "7.x", "8.x", "rolling")
        repeated string bazel = 2;
    }

    // A presubmit task configuration
    message PresubmitTask {
        // Task name
        string name = 1;
        // Platform (can be a template like "${{ platform }}" or literal)
        string platform = 2;
        // Bazel version (can be a template like "${{ bazel }}" or literal)
        string bazel = 3;
        // Build flags to pass to bazel build
        repeated string build_flags = 4;
        // Test flags to pass to bazel test
        repeated string test_flags = 5;
        // Build targets
        repeated string build_targets = 6;
        // Test targets
        repeated string test_targets = 7;
    }

    // bcr_test_module configuration (if present)
    BcrTestModule bcr_test_module = 1;
    // Top-level matrix (if bcr_test_module not present)
    PresubmitMatrix matrix = 2;
    // Top-level tasks (if bcr_test_module not present)
    map<string, PresubmitTask> tasks = 3;
}

// SymbolType represents the type of symbol
enum SymbolType {
    SYMBOL_TYPE_UNKNOWN = 0;
    SYMBOL_TYPE_RULE = 1;
    SYMBOL_TYPE_FUNCTION = 2;
    SYMBOL_TYPE_PROVIDER = 3;
    SYMBOL_TYPE_ASPECT = 4;
    SYMBOL_TYPE_MODULE_EXTENSION = 5;
    SYMBOL_TYPE_REPOSITORY_RULE = 6;
    SYMBOL_TYPE_MACRO = 7;
    SYMBOL_TYPE_RULE_MACRO = 8;
    SYMBOL_TYPE_VALUE = 9;
    SYMBOL_TYPE_LOAD_STMT = 10;
}

// SymbolInfo represents information about a symbol in a Bazel module
message SymbolInfo {
    // the type of symbol
    SymbolType type = 1;
    // the name of the symbol, which should match the name of the info type (e.g rule_name, provider_name, etc)
    string name = 2;
    // a truncated description from the underlying info
    string description = 3;
    // the underlying actual info data
    oneof info {
        build.stack.starlark.v1beta1.Rule rule = 4;
        build.stack.starlark.v1beta1.Function func = 5;
        build.stack.starlark.v1beta1.Provider provider = 6;
        build.stack.starlark.v1beta1.Aspect aspect = 7;
        build.stack.starlark.v1beta1.ModuleExtension module_extension = 9;
        build.stack.starlark.v1beta1.RepositoryRule repository_rule = 10;
        build.stack.starlark.v1beta1.Macro macro = 11;
        build.stack.starlark.v1beta1.RuleMacro rule_macro = 12;
        build.stack.starlark.v1beta1.Value value = 13;
        build.stack.starlark.v1beta1.LoadStmt load = 14;
    }
}

// Set of symbols in a file.
message FileInfo {
    // label that provides the symbols (e.g. //lib/private:copy_file.bzl)
    build.stack.starlark.v1beta1.Label label = 1;
    // a list of symbols
    repeated SymbolInfo symbol = 2;
    // a truncated description from the ModuleInfo.module_docstring
    string description = 3;
    // an error message, if the symbols from the file could not be
    // extracted.ArchiveOverride
    string error = 5;
}

enum DocumentationSource {
    DOCUMENTATION_SOURCE_UNKNOWN = 0;
    PUBLISHED = 1;
    BEST_EFFORT = 2;
}

// Set of documented bzl files for a module.
message DocumentationInfo {
    string module_name = 1;
    string version = 2;
    repeated FileInfo file = 3;
    DocumentationSource source = 4;
}

// Set of documented modules.
message DocumentationRegistry {
    repeated DocumentationInfo documentation = 1;
}

// Represents a node in the dependency tree computed by MVS algorithm.
message DependencyTreeNode {
    // The resolved module version for this dependency
    ModuleVersion module_version = 1;
    // The originally requested version (may differ from module_version.version if upgraded)
    string requested_version = 2;
    // Whether this version was upgraded by MVS
    bool upgraded = 3;
    // Whether this is a dev dependency
    bool dev = 4;
    // Child dependencies of this node
    repeated DependencyTreeNode children = 5;
    // Whether this node's children were pruned because the node was already visited in the tree
    bool pruned = 6;
    // The type of override applied to this dependency (empty string if no override)
    // Possible values: "single_version", "git", "archive", "local_path"
    string override_type = 7;
}

// Represents the complete dependency tree for a module version.
message DependencyTree {
    // The root module version
    ModuleVersion module_version = 1;
    // Child dependencies of the root module
    repeated DependencyTreeNode children = 2;
}

// Represents a node in the file load graph showing load dependencies.
message FileLoadTreeNode {
    // The file at this node
    FileInfo file = 1;
    // Files that this file loads (load dependencies)
    repeated FileLoadTreeNode children = 2;
    // Whether this node's children were pruned to avoid cycles
    bool pruned = 3;
}

// Represents the complete file load graph for a module.
message FileLoadTree {
    // Root files (files not loaded by any other file in the module)
    repeated FileLoadTreeNode roots = 1;
}
