name: Deploy and Auto-Merge BCR PR

on:
  pull_request:
    types: [opened, synchronize, labeled]

concurrency:
  group: deploy-bcr-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  deploy-and-merge:
    # Only run on PRs with the bcr-auto-update label and created by github-actions[bot]
    if: |
      contains(github.event.pull_request.labels.*.name, 'bcr-auto-update') &&
      github.event.pull_request.user.login == 'github-actions[bot]'
    runs-on: self-hosted
    environment: deploy
    permissions:
      contents: write
      pull-requests: write
      packages: write
    env:
      GITHUB_TOKEN: ${{ secrets.BCR_AUTOMATION_TOKEN }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          submodules: true
          token: ${{ secrets.BCR_AUTOMATION_TOKEN }}

      - name: Get BCR commit hash
        id: bcr_commit
        run: |
          BCR_SHA=$(git -C data/bazel-central-registry rev-parse HEAD)
          echo "sha=$BCR_SHA" >> $GITHUB_OUTPUT
          echo "Deploying with BCR commit: $BCR_SHA"

      - uses: bazel-contrib/setup-bazel@0.16.0

      - name: Enable auto-merge on PR
        run: |
          echo "Enabling auto-merge on PR #${{ github.event.pull_request.number }}"

          # Enable auto-merge - will merge when all checks (including this one) pass
          bazel run @multitool//tools/gh:gh -- pr merge ${{ github.event.pull_request.number }} \
            --auto \
            --squash \
            --delete-branch
        env:
          GH_TOKEN: ${{ secrets.BCR_AUTOMATION_TOKEN }}

      - name: Clean and initialize BCR
        run: make bcr_clean bcr_init bcr_update

      - name: Run BCR gazelle
        run: >-
          bazelisk
          --bazelrc=.github/workflows/ci.bazelrc
          --bazelrc=.bazelrc
          run
          //:bcr

      - name: Deploy to production
        id: deploy
        run: >-
          bazelisk
          --bazelrc=.github/workflows/ci.bazelrc
          --bazelrc=.bazelrc
          run
          --//app/bcr:release_type=production
          //app/bcr:deploy

      - name: Comment on PR if deployment failed
        if: failure()
        run: |
          # Disable auto-merge since deployment failed
          bazel run @multitool//tools/gh:gh -- pr merge ${{ github.event.pull_request.number }} --disable-auto || true

          bazel run @multitool//tools/gh:gh -- pr comment ${{ github.event.pull_request.number }} \
            --body "‚ùå Deployment failed for BCR commit \`${{ steps.bcr_commit.outputs.sha }}\`. Auto-merge has been disabled. Please review the logs and merge manually after fixing."
        env:
          GH_TOKEN: ${{ secrets.BCR_AUTOMATION_TOKEN }}
